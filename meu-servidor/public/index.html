<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Olha o Replay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/style.css">
    <style>
      /* Popup básico (apenas para o demo) */
      .popup.hidden { display: none; }
      /* utilitário para esconder elementos internos do popup */
      .hidden { display: none !important; }
      .popup { position: fixed; left: 0; right: 0; top: 0; bottom: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index:2000; }

  .popup-content { background:#fff; padding:2rem; border-radius:1rem; max-width:900px; width:95%; box-shadow:0 8px 30px rgba(0,0,0,.3); }
      /* Estilo completo do card de vídeo */
      .video-card { color:black;cursor: pointer;position:relative; border-radius:16px; background: #f8ead3; border: 1px solid ; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.2); transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
      .video-card:hover {  box-shadow: 0 12px 36px rgba(0, 0, 0, 0.623); border-color: rgba(255,255,255,0.16); }
      .video-card .card-body { display:flex; flex-direction:column; align-items:stretch; gap:.5rem; padding:.75rem 1rem 1rem; }
      .video-card .card-title { color:#000000; font-weight:600; }
      .video-card .badge { border-radius:10px; padding:.35rem .5rem; }
      .video-card .card-body p.text-muted { color:#5a5f63 !important; }
      .btn-brand-yellow { background: linear-gradient(135deg,#ffd54f,#ffb300); color:#111; border:none; }
      .btn-brand-yellow:hover { background: linear-gradient(135deg,#ffe082,#ffc107); color:#111; }
      /* Container estilizado da thumbnail */
      .thumb-box { position: relative; border-radius: 14px; padding: 2px; background: linear-gradient(135deg, #ffd54f, #ff6f61); box-shadow: 0 8px 24px rgba(0,0,0,.2); transition: transform .2s ease, box-shadow .2s ease; cursor: pointer; }
      .thumb-box:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,.28); }
      .thumb-box .ratio { overflow: hidden; border-radius: 12px; background: #111; }
      .thumb-video { width:100%; height:180px; object-fit:cover; display:block; }
      /* Overlay de play */
      .thumb-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; background: linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.25)); opacity:0; transition: opacity .2s ease; border-radius: 14px; pointer-events: none; }
      .thumb-box:hover .thumb-overlay { opacity:1; }
      .thumb-overlay i { font-size: 2rem; filter: drop-shadow(0 2px 6px rgba(0,0,0,.6)); }
    </style>
  </head>
  <body data-page="index">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm fixed-top brand-header">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="../../inicio/index.html">
          <img src="../../static/img/OLHA O REPLAY.jpg" alt="Olha o Replay" height="56" class="me-2">
          <span>Olha o Replay</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0" id="navLinks">
            <li class="nav-item"><a class="nav-link" href="../../buscar-videos/search.html">Vídeos</a></li>
            <li class="nav-item" id="navLogin"><a class="nav-link" href="../../login/login.html">Login</a></li>
            <li class="nav-item" id="navRegister"><a class="nav-link" href="../../registrar/register.html">Cadastrar</a></li>
            <li class="nav-item dropdown d-none" id="navUser">
              <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-user"></i> <span id="userName">Usuário</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                <li><a class="dropdown-item" href="../../buscar-videos/search.html">Meus Vídeos</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item" id="logoutBtn">Sair</button></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <div id="confirmArea">
        <h2>Confirmar Compra!</h2>
        <p id="confirmText">Compre este vídeo para assistir agora!</p>
        <div class="d-flex gap-2 justify-content-end mt-3">
          <button id="btn-comprar" class="btn btn-primary">Comprar e Assistir</button>
          <button id="btn-fechar" class="btn btn-secondary">Fechar</button>
        </div>
      </div>

      <div id="playerArea" class="hidden">
        <video id="popupVideo" controls style="width:100%; height:auto; max-height:80vh; background:#000"></video>
        <div class="mt-3 text-end">
          <button id="btn-close-player" class="btn btn-secondary">Fechar</button>
        </div>
      </div>
    </div>
  </div>

<!-- Vídeos (lista a partir da API local) -->
<section class="py-5">
  <div class="container">
    <h2 class="text-center mb-4">Vídeos disponíveis</h2>
    <div id="videosGrid" class="row g-4"></div>
  </div>
</section>

    <!-- Footer -->
    <footer class="py-4 bg-dark text-white">
      <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
        <span>© 2025 Olha o Replay. Todos os direitos reservados.</span>
        <div class="mt-3 mt-md-0">
          <a href="../../inicio/index.html" class="text-white me-3">Início</a>
          <a href="../../buscar-videos/search.html" class="text-white me-3">Buscar Vídeos</a>
          <a href="../../historico/purchases.html" class="text-white me-3">Compras</a>
          <a href="#" class="text-white">Contato</a>
        </div>
      </div>
    </footer>

    <script>
      (function(){
        const grid = document.getElementById('videosGrid');
        const popup = document.getElementById('popup');
        const btnClose = document.getElementById('btn-fechar');
        const btnComprar = document.getElementById('btn-comprar');
        const confirmText = document.getElementById('confirmText');
        const confirmArea = document.getElementById('confirmArea');
        const playerArea = document.getElementById('playerArea');
        const popupVideo = document.getElementById('popupVideo');
        const btnClosePlayer = document.getElementById('btn-close-player');
        let selectedVideo = null;
        let username = 'Usuário';

        async function loadUser(){
          try {
            const r = await fetch('/api/user');
            if (r.ok) {
              const data = await r.json();
              if (data && data.username) username = data.username;
            }
          } catch(e) { /* ignora e usa padrão */ }
        }

        async function loadVideos(){
          try{
            const res = await fetch('/api/videos');
            if(!res.ok) throw new Error('Falha ao buscar vídeos');
            const videos = await res.json();
            if(!Array.isArray(videos) || videos.length===0){
              grid.innerHTML = '<p class="text-muted">Nenhum vídeo disponível.</p>';
              return;
            }

            videos.forEach(name=>{
              const col = document.createElement('div');
              col.className = 'col-6 col-md-4 col-lg-3';
              const videoUrl = `/videos/${encodeURIComponent(name)}`;
              col.innerHTML = `
                <div class="card video-card h-100" data-video="${encodeURIComponent(name)}">
                  <div class="thumb-box">
                    <div class="thumb-overlay"><i class="fa-solid fa-play"></i></div>
                    <div class="ratio ratio-16x9">
                      <video class="thumb-video" muted preload="metadata" src="${videoUrl}" onloadedmetadata="this.currentTime=1"></video>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="card-title mb-0 text-truncate" title="${name}">${name}</h6>
                      <span class="badge bg-warning text-dark">R$ 10,00</span>
                    </div>
                    <p class="text-muted mb-3">Vendido por: ${username}</p>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-brand-yellow btn-open-pay">Comprar</button>
                    </div>
                  </div>
                </div>`;
              grid.appendChild(col);

              const openConfirm = ()=>{
                selectedVideo = name;
                confirmText.textContent = `Deseja comprar o vídeo "${name}" por R$ 10,00?`;
                // resetar áreas
                confirmArea.classList.remove('hidden');
                playerArea.classList.add('hidden');
                popup.classList.remove('hidden');
              };

              // Tornar o card inteiro clicável para abrir a confirmação
              col.querySelector('.video-card').addEventListener('click', openConfirm);
              // Botão também abre confirmação, sem duplicar via propagação
              col.querySelector('.btn-open-pay').addEventListener('click', (e)=>{ e.stopPropagation(); openConfirm(); });
            });
          }catch(err){
            console.error(err);
            grid.innerHTML = '<p class="text-danger">Erro ao carregar vídeos.</p>';
          }
        }

        // fechar popup de confirmação sem abrir o player
        btnClose.addEventListener('click', ()=>{
          popup.classList.add('hidden');
          // garantir que player esteja parado caso tenha sido aberto antes
          try { popupVideo.pause(); popupVideo.src = ''; } catch(e){}
          confirmArea.classList.remove('hidden');
          playerArea.classList.add('hidden');
        });

        // comprar -> abrir player dentro do popup
        btnComprar.addEventListener('click', ()=>{
          if(!selectedVideo) return;
          const videoUrl = `/videos/${encodeURIComponent(selectedVideo)}`;
          // mostrar player
          confirmArea.classList.add('hidden');
          playerArea.classList.remove('hidden');
          popupVideo.src = videoUrl;
          popupVideo.currentTime = 0;
          popupVideo.muted = false;
          popup.classList.remove('hidden');
          popupVideo.play().catch(()=>{});
        });

        // fechar player e pausar
        btnClosePlayer.addEventListener('click', ()=>{
          try { popupVideo.pause(); popupVideo.src = ''; } catch(e){}
          playerArea.classList.add('hidden');
          confirmArea.classList.remove('hidden');
          popup.classList.add('hidden');
        });

        // carregar ao iniciar
        loadUser().then(loadVideos);
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../static/js/main.js"></script>
</body>
</html>
